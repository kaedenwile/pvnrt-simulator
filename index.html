<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PVNRT</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div id="everything">
    <div id="everythingStretchyWrapper">
        <div id="header">
            <div id="title">PVNRT</div>
            <div id="download"><img id="downloadImage" src="img/download.png" alt=""/>Download simulator data</div>
        </div>
        <div id="mainContent">
            <div id="leftContainer">
                <div id="particleBoxContainer">
                    <div id="particleBoxHeader">
                        <div id="particleBoxSizeSelect">
                            <div class="strongText">STATIC</div>
                            <div class="weakText">ELASTIC</div>
                        </div>
                        <div id="particleBoxPressureNumeric">
                            <div id="weakPressureNumber" class="weakText">14.804 atm</div>
                            <div id="strongPressureNumber" class="strongText">1500 Pa</div>
                        </div>
                    </div>
                    <canvas id="particleBox"></canvas>
                    <img id="particleImg" class="hidden" src="img/particle.png"/>
                </div>
                <div id="controlsContainer">
                    <div id="temperatureControl" class="control">
                        <div class="controlMax">1000 K</div>
                        <div class="controlSliderBox">
                            <div class="controlBar temperature"></div>
                            <div id="tempSlider" class="controlSlider" style="left: 40%;" onmousedown="beginDragging(event, updateTemperature)"></div>
                        </div>
                        <div class="controlNumeric">
                            <div id="weakTemperatureNumber" class="weakText">-39 C</div>
                            <div id="strongTemperatureNumber" class="strongText">234 K</div>
                        </div>
                    </div>
                    <div id="volumeControl" class="control">
                        <div class="controlMax">20 m<sup>3</sup></div>
                        <div class="controlSliderBox">
                            <div class="controlBar volume"></div>
                            <div id="volumeSlider" class="controlSlider" style="left: 20%;" onmousedown="beginDragging(event, updateVolume)"></div>
                        </div>
                        <div class="controlNumeric">
                            <div id="weakVolumeNumber" class="weakText">17.69 ft<sup>3</sup></div>
                            <div id="strongVolumeNumber" class="strongText">8 m<sup>3</sup></div>
                        </div>
                    </div>
                    <div id="moleControl" class="control">
                        <div class="controlMax">30 M</div>
                        <div class="controlSliderBox">
                            <div class="controlBar molarity"></div>
                            <div id="moleSlider" class="controlSlider" style="left: 60%;" onmousedown="beginDragging(event, updateMolarity)"></div>
                        </div>
                        <div class="controlNumeric">
                            <div id="moleNumber" class="strongText">4 M</div>
                        </div>
                    </div>
                    <div id="particleColor" class="control">
                        <div id="particleColorButtonsContainer">
                            <div class="particleColorButton green" onclick="selectColor(event);"><div class="particleColorButtonCore"></div></div>
                            <div class="particleColorButton yellow" onclick="selectColor(event);"><div class="particleColorButtonCore"></div></div>
                            <div id="initialParticleColor" class="particleColorButton orange selected" onclick="selectColor(event);">
                                <div class="particleColorButtonCore"></div></div>
                            <div class="particleColorButton red" onclick="selectColor(event);"><div class="particleColorButtonCore"></div></div>
                            <div class="particleColorButton salmon" onclick="selectColor(event);"><div class="particleColorButtonCore"></div></div>
                            <div class="particleColorButton pink" onclick="selectColor(event);"><div class="particleColorButtonCore"></div></div>
                            <div class="particleColorButton purple" onclick="selectColor(event);"><div class="particleColorButtonCore"></div></div>
                            <div class="particleColorButton blue" onclick="selectColor(event);"><div class="particleColorButtonCore"></div></div>
                            <div class="particleColorButton sky" onclick="selectColor(event);"><div class="particleColorButtonCore"></div></div>
                        </div>
                        <div class="weakText">Particle Color</div>
                    </div>
                </div>
            </div>
            <div id="rightContainer">
                <div id="rightContainerWrapper">
                    <div id="workGraph"></div>
                    <div id="velocityGraph"></div>
                    <div id="numericOutput">
                        <table>
                            <tr><td>Pressure</td><td><span id="pressureOutput" class="outputNumber">1500</span>kPa</td></tr>
                            <tr><td>Volume</td><td><span id="volumeOutput" class="outputNumber">8</span>m<sup>3</sup></td></tr>
                            <tr><td>Number of Molecules</td><td><span id="moleOutput" class="outputNumber">4</span>moles</td></tr>
                            <tr><td>Temperature</td><td><span id="tempOutput" class="outputNumber">234</span>K</td></tr>
                            <tr><td>Average Particle Velocity</td><td><span id="velOutput" class="outputNumber">742</span>nm/s</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer">
            <div class="footerButton activeButton">Simulator</div>
            <div class="footerButton" onclick="location.href='howto.html';">How to Use</div>
            <div class="footerButton">Contact</div>
            <div class="footerButton">About</div>
            <div class="footerButton">Donate</div>
            <div class="footerButton">Get Corkboard</div>
            <div class="footerButton">Built by Kilometer Creative LLC</div>
        </div>
    </div>
</div>
<script>
    var currentStates = {
        P: 1500, // pressure of gas
        V: 8, // volume of gas
        n: 4, // moles of gas
        T: 360.8, // temperature of gas
        R: 8.3144598, // ideal gas constant
        m: 32 // mass of particle in amu
    };

    var currentColorButton = document.getElementById("initialParticleColor");

    var slider;
    var pageDimensions = {
        left: 0,
        sliderWidth: 0,
        boxWidth: 0,
        canvasWidth: 0,
        canvasHeight: 0
    };
    var updateFunction;
    measureWidths();

    window.addEventListener("resize", resize);
    window.addEventListener("mousemove", dragSlider);
    window.addEventListener("mouseup", endDragging);

    function resize() {
        measureWidths();
        updatedCurrentStates();
    }

    function beginDragging(event, func) {
        slider = event.target;
        updateFunction = func;
    }

    function dragSlider(event) {
        if (slider != null) {
            unfocus();

            var percentage = limit((event.clientX - pageDimensions.left) / pageDimensions.boxWidth);
            placeSlider(slider, percentage);
            updateFunction(percentage);
        }
    }

    function endDragging() {
        slider = null;
        unfocus();
    }

    function unfocus() {
        if (document.selection) {
            document.selection.empty()
        } else {
            window.getSelection().removeAllRanges()
        }
    }

    function measureWidths() {
        var slider = document.getElementById("tempSlider");
        pageDimensions.left = parseFloat(getComputedStyle(slider.parentNode).left);
        pageDimensions.sliderWidth = parseFloat(getComputedStyle(slider).width);
        pageDimensions.boxWidth = parseFloat(getComputedStyle(slider.parentNode).width);
        var pbox = document.getElementById("particleBox");
        pageDimensions.canvasWidth = parseFloat(getComputedStyle(pbox).width);
        pageDimensions.canvasHeight = parseFloat(getComputedStyle(pbox).height);
    }

    function placeSlider(slider, percentage) {
        slider.style.left = percentage*pageDimensions.boxWidth - pageDimensions.sliderWidth / 2  + 'px';
    }

    function colorsFromHex(hex) {
        return {
            r: parseInt(hex.substr(1, 2), 16) / 256,
            g: parseInt(hex.substr(3, 2), 16) / 256,
            b: parseInt(hex.substr(5, 2), 16) / 256
        }
    }

    function colorsToHex(colors) {
        return "#"+('00'+Math.round(colors.r*256).toString(16)).slice(-2) +
                   ('00'+Math.round(colors.g*256).toString(16)).slice(-2) +
                   ('00'+Math.round(colors.b*256).toString(16)).slice(-2);
    }

    function doSliderColor(slider, c1, c2, percentage) {
        var rgb1 = colorsFromHex(c1);
        var rgb2 = colorsFromHex(c2);

        slider.style.backgroundColor = colorsToHex({
            r: rgb1.r + (rgb2.r-rgb1.r)*percentage,
            g: rgb1.g + (rgb2.g-rgb1.g)*percentage,
            b: rgb1.b + (rgb2.b-rgb1.b)*percentage
        });
    }

    function limit(percentage) {
        if (percentage < 0) {
            percentage = 0;
        } else if (percentage > 1) {
            percentage = 1;
        }
        return percentage;
    }

    function selectColor(event) {
        currentColorButton.classList.remove("selected");
        currentColorButton = event.target;
        currentColorButton.classList.add("selected");
    }

    function updateTemperature(value) {
        currentStates.T = 1000*value;
        updatePressure();

        updatedCurrentStates();
    }

    function updateVolume(value) {
        currentStates.V = 20*value;
        updatePressure();

        updatedCurrentStates();
    }

    function updateMolarity(value) {
        currentStates.n = 30*value;
        editGasAmount();
        updatePressure();

        updatedCurrentStates();
    }

    function updatePressure() {
        currentStates.P = currentStates.n * currentStates.R * currentStates.T / currentStates.V;
        if (currentStates.n === 0 || currentStates.T === 0) {
            currentStates.P = 0;
        } else if (currentStates.V === 0) {
            currentStates.P = Infinity;
        }
    }

    function updatedCurrentStates() {
        document.getElementById("strongTemperatureNumber").innerHTML = (currentStates.T).toFixed() +" K";
        document.getElementById("weakTemperatureNumber").innerHTML = (currentStates.T-273).toFixed() +" C";
        placeSlider(document.getElementById("tempSlider"), limit(currentStates.T / 1000));
        doSliderColor(document.getElementById("tempSlider"), "#180b77", "#a9050e", limit(currentStates.T / 1000));

        document.getElementById("strongVolumeNumber").innerHTML = (currentStates.V).toFixed() +" m<sup>3</sup>";
        document.getElementById("weakVolumeNumber").innerHTML = (currentStates.V * 35.3147).toFixed(3) +" ft<sup>3</sup>";
        placeSlider(document.getElementById("volumeSlider"), limit(currentStates.V / 20));
        doSliderColor(document.getElementById("volumeSlider"), "#0e699b", "#091a6b", limit(currentStates.V / 20));

        document.getElementById("moleNumber").innerHTML = (currentStates.n).toFixed(1) +" M";
        placeSlider(document.getElementById("moleSlider"), limit(currentStates.n / 30));
        doSliderColor(document.getElementById("moleSlider"), "#d59339", "#fc551f", limit(currentStates.n / 30));

        document.getElementById("strongPressureNumber").innerHTML = (currentStates.P).toFixed() + " kPa";
        document.getElementById("weakPressureNumber").innerHTML = (currentStates.P / 101325).toFixed(3) + " atm";

        document.getElementById("pressureOutput").innerHTML = (currentStates.P).toFixed();
        document.getElementById("volumeOutput").innerHTML = (currentStates.V).toFixed();
        document.getElementById("moleOutput").innerHTML = (currentStates.n).toFixed(1);
        document.getElementById("tempOutput").innerHTML = (currentStates.T).toFixed();
        document.getElementById("velOutput").innerHTML = (Math.sqrt(currentStates.T * 3 * 1.38064853E-23 / (currentStates.m * 1E-10) *
            1E9 /* nm */)).toFixed(2);
    }
    updatedCurrentStates();

    function colorizeParticle(color) {

    }

    var gasParticles = [];
    function editGasAmount() {
        var gasCount = Math.round(currentStates.n * 10);
        if (gasCount > gasParticles.length) {
            while (gasParticles.length < gasCount) { gasParticles.push([Math.random(), Math.random()]); }
        } else if (gasCount < gasParticles.length) {
            while (gasParticles.length > gasCount) { gasParticles.splice(Math.floor(Math.random()*gasParticles.length),1); }
        }
    }

//    var pause = false;
//    function unpause() {
//        if (pause) {
//            pause = false;
//            gasLoop();
//        }
//    }

    function gasLoop() {
        animateGas();
        drawGas();

//        if (pause) return;
        window.requestAnimationFrame(gasLoop);
    }

    var lastTime = new Date().getTime();
    function animateGas() {
        var now = new Date().getTime();
        var dt = (now - lastTime) / 1000; // seconds
        var m = currentStates.T / 1000; // movement speed, depends on temperature
        for (var i = 0; i < gasParticles.length; i++) {
            var p = gasParticles[i]; // this particle

//            var r = gasParticles[Math.floor(Math.random()*gasParticles.length)]; // randomly picked particle
//            var dp = [p[0]-r[0], p[1]-r[1]]; // delta between p and r
//            if (dp[0] > 0) {
//                n[0] += m * dt / (dp[0]);
//            }
//            if (dp[1] > 0) {
//                n[1] += m * dt / (dp[1]);
//            }

            var n = [p[0] + (Math.random()*2-1)*m*dt, p[1] + (Math.random()*2-1)*m*dt]; // new Position

            // bound particle to box, keep from congregating in corners
            if (n[0] < 0) {
                n[0] = -n[0]
            } else if (n[0] > 1) {
                n[0] = 2 - n[0];
            }
            if (n[1] < 0) {
                n[1] = -n[1]
            } else if (n[1] > 1) {
                n[1] = 2 - n[1];
            }

            gasParticles[i] = [n[0], n[1]] // set particle
        }
        lastTime = now;
    }

    function drawGas() {
        var canvas = document.getElementById("particleBox");
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "#141414";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        var particleImage = document.getElementById("particleImg");
        var radius = 40 / currentStates.V; if (currentStates.V < 0.8) { radius = 50; }
        var w = canvas.width - 2*radius, h = canvas.height - 2*radius;
        for (var i = 0; i < gasParticles.length; i++) {
            var particle = gasParticles[i];
            ctx.drawImage(particleImage, particle[0] * w, particle[1] * h, radius*2, radius*2);
        }
    }

    editGasAmount();
    gasLoop();
</script>
</body>
</html>